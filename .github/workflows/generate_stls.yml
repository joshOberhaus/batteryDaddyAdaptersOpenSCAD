name: Generate Release STLs

on:
  push:
    branches:
      - main
    tags:
      - '*'
    paths:
      - '*.scad'
      - '.github/workflows/generate_stls.yml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  generate-stls:
    runs-on: ubuntu-latest
    
    container:
      image: ubuntu:latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install OpenSCAD
        run: |
          apt-get update
          apt-get install -y openscad python3
      
      - name: Generate Release
        run: |
          python3 generate_release.py
      
      - name: Check Release Status
        run: |
          if [ -d "releases" ] && [ "$(find releases -name '*.stl' | wc -l)" -gt 0 ]; then
            echo "RELEASE_STATUS=success" >> $GITHUB_ENV
          else
            echo "RELEASE_STATUS=failed" >> $GITHUB_ENV
          fi
      
      - name: Find Latest Release Directory
        id: find_release
        run: |
          LATEST_RELEASE=$(ls -td releases/Release-* 2>/dev/null | head -1)
          if [ -z "$LATEST_RELEASE" ]; then
            echo "Error: No release directory found"
            exit 1
          fi
          echo "release_dir=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "Found release: $LATEST_RELEASE"
          ls -la "$LATEST_RELEASE/stls/" | head -5
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: battery-adapters-release
          path: ${{ steps.find_release.outputs.release_dir }}
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_release.outputs.release_dir }}/stls/*.stl
          body_path: ${{ steps.find_release.outputs.release_dir }}/MANIFEST.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
